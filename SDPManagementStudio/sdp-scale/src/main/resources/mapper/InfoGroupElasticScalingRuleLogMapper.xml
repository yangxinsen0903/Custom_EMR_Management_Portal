<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunbox.sdpscale.mapper.InfoGroupElasticScalingRuleLogMapper">
    <resultMap id="BaseResultMap" type="com.sunbox.domain.InfoGroupElasticScalingRuleLog">
        <id column="es_rule_log_id" jdbcType="BIGINT" property="esRuleLogId"/>
        <result column="es_rule_id" jdbcType="VARCHAR" property="esRuleId"/>
        <result column="cluster_id" jdbcType="VARCHAR" property="clusterId"/>
        <result column="load_metric" jdbcType="VARCHAR" property="loadMetric"/>
        <result column="aggregate_type" jdbcType="VARCHAR" property="aggregateType"/>
        <result column="operator" jdbcType="VARCHAR" property="operator"/>
        <result column="threshold" jdbcType="DOUBLE" property="threshold"/>
        <result column="metric_val" jdbcType="DOUBLE" property="metricVal"/>
        <result column="is_start_scaling" jdbcType="INTEGER" property="isStartScaling"/>
        <result column="created_time" jdbcType="TIMESTAMP" property="createdTime"/>
        <result column="metric_start_time" jdbcType="TIMESTAMP" property="metricStartTime"/>
        <result column="metric_end_time" jdbcType="TIMESTAMP" property="metricEndTime"/>
        <result column="compute_result" jdbcType="INTEGER" property="computeResult"/>
        <result column="scale_server_ip" jdbcType="VARCHAR" property="scaleServerIp"/>
    </resultMap>
    <sql id="Base_Column_List">
        es_rule_log_id, es_rule_id, cluster_id, load_metric, aggregate_type, operator, threshold,
        metric_val, is_start_scaling, created_time
    </sql>
    <select id="selectComputePassInWindowSize" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from info_group_elastic_scaling_rule_log
        where es_rule_id = #{esRuleId,jdbcType=VARCHAR}
        and load_metric=#{loadMetric,jdbcType=VARCHAR}
        and created_time&lt; #{createdTime,jdbcType=TIMESTAMP}
        and aggregate_type = #{aggregateType,jdbcType=VARCHAR}
        and compute_result = 1
        and es_rule_log_id &gt; (
            select ifnull(max(es_rule_log_id),0) from info_group_elastic_scaling_rule_log
            where es_rule_id = #{esRuleId,jdbcType=VARCHAR}
            and load_metric=#{loadMetric,jdbcType=VARCHAR}
            and aggregate_type=#{aggregateType,jdbcType=VARCHAR}
            and task_result='true'
        )
        order by created_time desc
        limit #{repeatCount}
    </select>
    <insert id="insertSelective" parameterType="com.sunbox.domain.InfoGroupElasticScalingRuleLog"
            useGeneratedKeys="true" keyProperty="esRuleLogId" keyColumn="es_rule_log_id">
        insert into info_group_elastic_scaling_rule_log
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="esRuleLogId != null">
                es_rule_log_id,
            </if>
            <if test="esRuleId != null">
                es_rule_id,
            </if>
            <if test="clusterId != null">
                cluster_id,
            </if>
            <if test="loadMetric != null">
                load_metric,
            </if>
            <if test="aggregateType != null">
                aggregate_type,
            </if>
            <if test="operator != null">
                operator,
            </if>
            <if test="threshold != null">
                threshold,
            </if>
            <if test="metricVal != null">
                metric_val,
            </if>
            <if test="isStartScaling != null">
                is_start_scaling,
            </if>
            <if test="createdTime != null">
                created_time,
            </if>
            <if test="computeResult != null">
                compute_result,
            </if>
            <if test="scaleServerIp != null">
                scale_server_ip,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="esRuleLogId != null">
                #{esRuleLogId,jdbcType=BIGINT},
            </if>
            <if test="esRuleId != null">
                #{esRuleId,jdbcType=VARCHAR},
            </if>
            <if test="clusterId != null">
                #{clusterId,jdbcType=VARCHAR},
            </if>
            <if test="loadMetric != null">
                #{loadMetric,jdbcType=VARCHAR},
            </if>
            <if test="aggregateType != null">
                #{aggregateType,jdbcType=VARCHAR},
            </if>
            <if test="operator != null">
                #{operator,jdbcType=VARCHAR},
            </if>
            <if test="threshold != null">
                #{threshold,jdbcType=DOUBLE},
            </if>
            <if test="metricVal != null">
                #{metricVal,jdbcType=DOUBLE},
            </if>
            <if test="isStartScaling != null">
                #{isStartScaling,jdbcType=INTEGER},
            </if>
            <if test="createdTime != null">
                #{createdTime,jdbcType=TIMESTAMP},
            </if>
            <if test="computeResult != null">
                #{computeResult,jdbcType=INTEGER},
            </if>
            <if test="scaleServerIp != null">
                #{scaleServerIp,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <!-- 更新数据 -->
    <update id="update">
        update info_group_elastic_scaling_rule_log
        <set>
            <if test="esRuleId != null">
                es_rule_id = #{esRuleId,jdbcType=VARCHAR},
            </if>
            <if test="clusterId != null">
                cluster_id = #{clusterId,jdbcType=VARCHAR},
            </if>
            <if test="loadMetric != null">
                load_metric = #{loadMetric,jdbcType=VARCHAR},
            </if>
            <if test="aggregateType != null">
                aggregate_type = #{aggregateType,jdbcType=VARCHAR},
            </if>
            <if test="operator != null">
                operator = #{operator,jdbcType=VARCHAR},
            </if>
            <if test="threshold != null">
                threshold = #{threshold,jdbcType=DOUBLE},
            </if>
            <if test="metricVal != null">
                metric_val = #{metricVal,jdbcType=DOUBLE},
            </if>
            <if test="isStartScaling != null">
                is_start_scaling = #{isStartScaling,jdbcType=INTEGER},
            </if>
            <if test="createdTime != null">
                created_time = #{createdTime,jdbcType=TIMESTAMP},
            </if>
            <if test="metricStartTime != null">
                metric_start_time = #{metricStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="metricEndTime != null">
                metric_end_time = #{metricEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="computeResult != null">
                compute_result = #{computeResult,jdbcType=INTEGER},
            </if>
            <if test="scaleServerIp != null">
                scale_server_ip = #{scaleServerIp,jdbcType=VARCHAR},
            </if>
            <if test="taskId != null">
                task_id = #{taskId,jdbcType=VARCHAR},
            </if>
            <if test="taskResult != null">
                task_result = #{taskResult,jdbcType=VARCHAR},
            </if>
            <if test="taskResultMessage != null">
                task_result_message = #{taskResultMessage,jdbcType=VARCHAR},
            </if>
        </set>
        where es_rule_log_id = #{esRuleLogId}
    </update>
</mapper>