<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunbox.sdpcompose.mapper.InfoClusterOperationPlanActivityLogMapper">
  <resultMap id="BaseResultMap" type="com.sunbox.domain.InfoClusterOperationPlanActivityLog">
    <id column="activity_log_id" jdbcType="VARCHAR" property="activityLogId" />
    <result column="plan_id" jdbcType="VARCHAR" property="planId" />
    <result column="activity_id" jdbcType="VARCHAR" property="activityId" />
    <result column="template_id" jdbcType="VARCHAR" property="templateId" />
    <result column="activity_type" jdbcType="VARCHAR" property="activityType" />
    <result column="activity_cnname" jdbcType="VARCHAR" property="activityCnname" />
    <result column="activity_name" jdbcType="VARCHAR" property="activityName" />
    <result column="timeout" jdbcType="INTEGER" property="timeout"/>
    <result column="sort_no" jdbcType="INTEGER" property="sortNo" />
    <result column="begtime" jdbcType="TIMESTAMP" property="begtime" />
    <result column="endtime" jdbcType="TIMESTAMP" property="endtime" />
    <result column="duration" jdbcType="INTEGER" property="duration" />
    <result column="state" jdbcType="INTEGER" property="state" />
    <result column="retry_count" jdbcType="INTEGER" property="retryCount"/>
    <result column="createdby" jdbcType="VARCHAR" property="createdby" />
    <result column="created_time" jdbcType="TIMESTAMP" property="createdTime" />
    <result column="last_retry_time" jdbcType="TIMESTAMP" property="lastRetryTime"/>
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    <result column="paraminfo" jdbcType="LONGVARCHAR" property="paraminfo" />
    <result column="logs" jdbcType="LONGVARCHAR" property="logs" />
  </resultMap>
  <sql id="Base_Column_List">
    activity_log_id, plan_id, activity_id, template_id, activity_type, activity_cnname, activity_name,
    sort_no, timeout,begtime, endtime, duration, state, retry_count,createdby, created_time,last_retry_time
  </sql>
  <sql id="Blob_Column_List">
    paraminfo, logs
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="ResultMapWithBLOBs">
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from info_cluster_operation_plan_activity_log
    where activity_log_id = #{activityLogId,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from info_cluster_operation_plan_activity_log
    where activity_log_id = #{activityLogId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    insert into info_cluster_operation_plan_activity_log (activity_log_id, plan_id, activity_id, 
      template_id, activity_type, activity_cnname, activity_name,
      sort_no, timeout,begtime, endtime,
      duration, state, retry_count,createdby,
      created_time,last_retry_time, paraminfo, logs
      )
    values (#{activityLogId,jdbcType=VARCHAR}, #{planId,jdbcType=VARCHAR}, #{activityId,jdbcType=VARCHAR}, 
      #{templateId,jdbcType=VARCHAR}, #{activityType,jdbcType=VARCHAR}, #{activityCnname,jdbcType=VARCHAR}, #{activityName,jdbcType=VARCHAR},
      #{sortNo,jdbcType=INTEGER},#{timeout,jdbcType=INTEGER} #{begtime,jdbcType=TIMESTAMP}, #{endtime,jdbcType=TIMESTAMP},
      #{duration,jdbcType=INTEGER}, #{state,jdbcType=INTEGER},#{retry_count,jdbcType=INTEGER},#{createdby,jdbcType=VARCHAR},
      #{createdTime,jdbcType=TIMESTAMP},#{lastRetryTime,jdbcType=TIMESTAMP},#{paraminfo,jdbcType=LONGVARCHAR}, #{logs,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    insert into info_cluster_operation_plan_activity_log
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="activityLogId != null">
        activity_log_id,
      </if>
      <if test="planId != null">
        plan_id,
      </if>
      <if test="activityId != null">
        activity_id,
      </if>
      <if test="templateId != null">
        template_id,
      </if>
      <if test="activityType != null">
        activity_type,
      </if>
      <if test="activityName != null">
        activity_name,
      </if>
      <if test="sortNo != null">
        sort_no,
      </if>
      <if test="timeout != null">
        timeout,
      </if>
      <if test="begtime != null">
        begtime,
      </if>
      <if test="endtime != null">
        endtime,
      </if>
      <if test="duration != null">
        duration,
      </if>
      <if test="state != null">
        state,
      </if>
      <if test="retryCount != null">
        retry_count,
      </if>
      <if test="createdby != null">
        createdby,
      </if>
      <if test="createdTime != null">
        created_time,
      </if>
      <if test="lastRetryTime != null">
        last_retry_time,
      </if>
      <if test="paraminfo != null">
        paraminfo,
      </if>
      <if test="logs != null">
        logs,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="activityLogId != null">
        #{activityLogId,jdbcType=VARCHAR},
      </if>
      <if test="planId != null">
        #{planId,jdbcType=VARCHAR},
      </if>
      <if test="activityId != null">
        #{activityId,jdbcType=VARCHAR},
      </if>
      <if test="templateId != null">
        #{templateId,jdbcType=VARCHAR},
      </if>
      <if test="activityType != null">
        #{activityType,jdbcType=VARCHAR},
      </if>
      <if test="activityName != null">
        #{activityName,jdbcType=VARCHAR},
      </if>
      <if test="sortNo != null">
        #{sortNo,jdbcType=INTEGER},
      </if>
      <if test="timeout != null">
        #{timeout,jdbcType=INTEGER},
      </if>
      <if test="begtime != null">
        #{begtime,jdbcType=TIMESTAMP},
      </if>
      <if test="endtime != null">
        #{endtime,jdbcType=TIMESTAMP},
      </if>
      <if test="duration != null">
        #{duration,jdbcType=INTEGER},
      </if>
      <if test="state != null">
        #{state,jdbcType=INTEGER},
      </if>
      <if test="retryCount != null">
        #{retryCount,jdbcType=INTEGER},
      </if>
      <if test="createdby != null">
        #{createdby,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null">
        #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastRetryTime != null">
        #{lastRetryTime,jdbcType=TIMESTAMP},
      </if>
      <if test="paraminfo != null">
        #{paraminfo,jdbcType=LONGVARCHAR},
      </if>
      <if test="logs != null">
        #{logs,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
    <insert id="insertBatch">
      insert into info_cluster_operation_plan_activity_log (activity_log_id, plan_id, activity_id,
                                                            template_id, activity_type, activity_cnname, activity_name,
                                                            sort_no, timeout, begtime, endtime,
                                                            duration, state,retry_count,createdby,
                                                            created_time,last_retry_time, paraminfo, logs
      ) values
    <foreach collection="logs"  item="log" separator=",">
             (#{log.activityLogId,jdbcType=VARCHAR}, #{log.planId,jdbcType=VARCHAR}, #{log.activityId,jdbcType=VARCHAR},
              #{log.templateId,jdbcType=VARCHAR}, #{log.activityType,jdbcType=VARCHAR}, #{log.activityCnname,jdbcType=VARCHAR}, #{log.activityName,jdbcType=VARCHAR},
              #{log.sortNo,jdbcType=INTEGER}, #{log.timeout,jdbcType=INTEGER}, #{log.begtime,jdbcType=TIMESTAMP}, #{log.endtime,jdbcType=TIMESTAMP},
              #{log.duration,jdbcType=INTEGER}, #{log.state,jdbcType=INTEGER},#{log.retryCount,jdbcType=INTEGER}, #{log.createdby,jdbcType=VARCHAR},
              #{log.createdTime,jdbcType=TIMESTAMP}, #{log.lastRetryTime,jdbcType=TIMESTAMP},#{log.paraminfo,jdbcType=LONGVARCHAR}, #{log.logs,jdbcType=LONGVARCHAR}
             )
      </foreach>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    update info_cluster_operation_plan_activity_log
    <set>
      <if test="planId != null">
        plan_id = #{planId,jdbcType=VARCHAR},
      </if>
      <if test="activityId != null">
        activity_id = #{activityId,jdbcType=VARCHAR},
      </if>
      <if test="templateId != null">
        template_id = #{templateId,jdbcType=VARCHAR},
      </if>
      <if test="activityType != null">
        activity_type = #{activityType,jdbcType=VARCHAR},
      </if>
      <if test="activityName != null">
        activity_name = #{activityName,jdbcType=VARCHAR},
      </if>
      <if test="sortNo != null">
        sort_no = #{sortNo,jdbcType=INTEGER},
      </if>
      <if test="timeout != null">
        timeout = #{timeout,jdbcType=INTEGER},
      </if>
      <if test="begtime != null">
        begtime = #{begtime,jdbcType=TIMESTAMP},
      </if>
      <if test="endtime != null">
        endtime = #{endtime,jdbcType=TIMESTAMP},
      </if>
      <if test="duration != null">
        duration = #{duration,jdbcType=INTEGER},
      </if>
      <if test="state != null">
        state = #{state,jdbcType=INTEGER},
      </if>
      <if test="retryCount != null">
        retry_count = #{retryCount,jdbcType=INTEGER},
      </if>
      <if test="createdby != null">
        createdby = #{createdby,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null">
        created_time = #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastRetryTime != null">
        last_retry_time = #{lastRetryTime,jdbcType=TIMESTAMP},
      </if>
      <if test="paraminfo != null">
        paraminfo = #{paraminfo,jdbcType=LONGVARCHAR},
      </if>
      <if test="logs != null">
        logs = #{logs,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where activity_log_id = #{activityLogId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    update info_cluster_operation_plan_activity_log
    set plan_id = #{planId,jdbcType=VARCHAR},
      activity_id = #{activityId,jdbcType=VARCHAR},
      template_id = #{templateId,jdbcType=VARCHAR},
      activity_type = #{activityType,jdbcType=VARCHAR},
      activity_name = #{activityName,jdbcType=VARCHAR},
      sort_no = #{sortNo,jdbcType=INTEGER},
      timeout = #{timeout,jdbcType=INTEGER},
      begtime = #{begtime,jdbcType=TIMESTAMP},
      endtime = #{endtime,jdbcType=TIMESTAMP},
      duration = #{duration,jdbcType=INTEGER},
      state = #{state,jdbcType=INTEGER},
      retry_count = #{retryCount,jdbcType=INTEGER},
      createdby = #{createdby,jdbcType=VARCHAR},
      created_time = #{createdTime,jdbcType=TIMESTAMP},
      last_retry_time = #{lastRetryTime,jdbcType=TIMESTAMP},
      paraminfo = #{paraminfo,jdbcType=LONGVARCHAR},
      logs = #{logs,jdbcType=LONGVARCHAR}
    where activity_log_id = #{activityLogId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sunbox.domain.InfoClusterOperationPlanActivityLog">
    update info_cluster_operation_plan_activity_log
    set plan_id = #{planId,jdbcType=VARCHAR},
      activity_id = #{activityId,jdbcType=VARCHAR},
      template_id = #{templateId,jdbcType=VARCHAR},
      activity_type = #{activityType,jdbcType=VARCHAR},
      activity_name = #{activityName,jdbcType=VARCHAR},
      sort_no = #{sortNo,jdbcType=INTEGER},
      timeout = #{timeout,jdbcType=INTEGER},
      begtime = #{begtime,jdbcType=TIMESTAMP},
      endtime = #{endtime,jdbcType=TIMESTAMP},
      duration = #{duration,jdbcType=INTEGER},
      state = #{state,jdbcType=INTEGER},
      retry_count = #{retryCount,jdbcType=INTEGER},
      createdby = #{createdby,jdbcType=VARCHAR},
      created_time = #{createdTime,jdbcType=TIMESTAMP},
      last_retry_time = #{lastRetryTime,jdbcType=TIMESTAMP}
    where activity_log_id = #{activityLogId,jdbcType=VARCHAR}
  </update>
  <select id="getAllActivity" resultType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    select
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from info_cluster_operation_plan_activity_log
    where plan_id = #{planId,jdbcType=VARCHAR}
  </select>
  <select id="getNextActivity" resultType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
      select
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
      from info_cluster_operation_plan_activity_log
      where plan_id = #{planId,jdbcType=VARCHAR}
        and sort_no > (
            select sort_no from info_cluster_operation_plan_activity_log
                       where activity_log_id=#{activityLogId,jdbcType=VARCHAR}
                         and plan_id=#{planId,jdbcType=VARCHAR} )
      order by sort_no asc limit 1
  </select>
  <select id="getFirstActivity" resultType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
    select
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from info_cluster_operation_plan_activity_log
    where plan_id = #{planId,jdbcType=VARCHAR}
    order by sort_no asc limit 1
  </select>
    <select id="getRunningStateAndTimeoutActivity" resultType="java.util.HashMap">
      select cc.cluster_id,icop.plan_id,activity_log_id
      from info_cluster_operation_plan_activity_log icopal
      inner join info_cluster_operation_plan icop on icopal.plan_id=icop.plan_id
      inner join conf_cluster cc on icop.cluster_id = cc.cluster_id
      and cc.state in (2,1,-1) and icopal.state =1 and if(timeout=0,#{timeout,jdbcType=INTEGER},timeout) &lt; (UNIX_TIMESTAMP(now()) - UNIX_TIMESTAMP(icopal.begtime)-120)
    </select>
    <select id="getPrevActivity" resultType="com.sunbox.domain.InfoClusterOperationPlanActivityLogWithBLOBs">
      select
      <include refid="Base_Column_List" />
      ,
      <include refid="Blob_Column_List" />
      from info_cluster_operation_plan_activity_log
      where plan_id = #{planId,jdbcType=VARCHAR}
      and sort_no &lt; (
      select sort_no from info_cluster_operation_plan_activity_log
      where activity_log_id=#{activityLogId,jdbcType=VARCHAR}
      and plan_id=#{planId,jdbcType=VARCHAR} )
      order by sort_no desc limit 1
    </select>
</mapper>