<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunbox.dao.mapper.ConfScalingTaskNeoMapper">
    <resultMap id="BaseResultMap" type="com.sunbox.domain.ConfScalingTask">
        <id column="task_id" jdbcType="VARCHAR" property="taskId"/>
        <result column="cluster_id" jdbcType="VARCHAR" property="clusterId"/>
        <result column="group_name" jdbcType="VARCHAR" property="groupName"/>
        <result column="scaling_type" jdbcType="INTEGER" property="scalingType"/>
        <result column="vm_role" jdbcType="VARCHAR" property="vmRole"/>
        <result column="es_rule_id" jdbcType="VARCHAR" property="esRuleId"/>
        <result column="es_rule_name" jdbcType="VARCHAR" property="esRuleName"/>
        <result column="before_scaling_count" jdbcType="INTEGER" property="beforeScalingCount"/>
        <result column="after_scaling_count" jdbcType="INTEGER" property="afterScalingCount"/>
        <result column="scaling_count" jdbcType="INTEGER" property="scalingCount"/>
        <result column="is_graceful_scalein" jdbcType="INTEGER" property="isGracefulScalein"/>
        <result column="scalein_waitingtime" jdbcType="INTEGER" property="scaleinWaitingtime"/>
        <result column="operatiion_type" jdbcType="INTEGER" property="operatiionType"/>
        <result column="beg_time" jdbcType="TIMESTAMP" property="begTime"/>
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime"/>
        <result column="state" jdbcType="INTEGER" property="state"/>
        <result column="in_queue" jdbcType="INTEGER" property="inQueue"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="enable_beforestart_script" jdbcType="INTEGER" property="enableBeforestartScript"/>
        <result column="enable_afterstart_script" jdbcType="INTEGER" property="enableAfterstartScript"/>
        <result column="default_username" jdbcType="VARCHAR" property="defaultUsername"/>
        <result column="force_scalein_data_node" jdbcType="INTEGER" property="forceScaleinDataNode"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
    </resultMap>
    <sql id="Base_Column_List">
        task_id
        , cluster_id, group_name, scaling_type, vm_role, es_rule_id, es_rule_name,
        before_scaling_count, after_scaling_count, scaling_count, is_graceful_scalein, scalein_waitingtime,
        operatiion_type, beg_time, end_time, state, enable_beforestart_script, enable_afterstart_script,
        default_username,in_queue,create_time,
        force_scalein_data_node,
        remark
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where task_id = #{taskId,jdbcType=VARCHAR}
    </select>

    <select id="selectByParamsOrderByCreateTimeAsc" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR}
        <if test="vmRole!=null and vmRole!=''">
            and vm_role = #{vmRole,jdbcType=VARCHAR}
        </if>
        <if test="groupName!=null and groupName!=''">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="state != null">
            and state = #{state,jdbcType=INTEGER}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
        <if test="operatiionType != null">
            and operatiion_type = #{operatiionType,jdbcType=INTEGER}
        </if>
        <if test="inQueue != null">
            and in_queue = #{inQueue,jdbcType=INTEGER}
        </if>
        <if test="esRuleName != null and esRuleName!=''">
            and es_rule_name like concat('%',#{esRuleName,jdbcType=VARCHAR},'%')
        </if>
        <if test="begTime!=null">
            and beg_time <![CDATA[>=]]> #{begTime}
        </if>
        <if test="endTime!=null">
            and end_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="createTime!=null">
            and create_time <![CDATA[<]]> #{createTime}
        </if>
        <if test="scalingTypes!=null and scalingTypes.size>0">
            and scaling_type in
            <foreach collection="scalingTypes" item="scalingType" open="(" close=")" separator=",">
                #{scalingType}
            </foreach>
        </if>
        order by create_time ASC
        <if test="page!=null and size!=null">
            limit #{page}, #{size}
        </if>
    </select>

    <select id="selectByParamsOrderByBeginTimeDesc" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR}
        <if test="vmRole!=null and vmRole!=''">
            and vm_role = #{vmRole,jdbcType=VARCHAR}
        </if>
        <if test="groupName!=null and groupName!=''">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="state != null">
            and state = #{state,jdbcType=INTEGER}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
        <if test="operatiionType != null">
            and operatiion_type = #{operatiionType,jdbcType=INTEGER}
        </if>
        <if test="inQueue != null">
            and in_queue = #{inQueue,jdbcType=INTEGER}
        </if>
        <if test="esRuleName != null and esRuleName!=''">
            and es_rule_name like concat('%',#{esRuleName,jdbcType=VARCHAR},'%')
        </if>
        <if test="begTime!=null">
            and beg_time <![CDATA[>=]]> #{begTime}
        </if>
        <if test="endTime!=null">
            and end_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="createTime!=null">
            and create_time <![CDATA[<]]> #{createTime}
        </if>
        <if test="scalingTypes!=null and scalingTypes.size>0">
            and scaling_type in
            <foreach collection="scalingTypes" item="scalingType" open="(" close=")" separator=",">
                #{scalingType}
            </foreach>
        </if>
        order by beg_time DESC
        <if test="page!=null and size!=null">
            limit #{page}, #{size}
        </if>
    </select>

    <select id="selectByParamsOrderByEndTimeAsc" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR} and scaling_type != 3
        <if test="vmRole!=null and vmRole!=''">
            and vm_role = #{vmRole,jdbcType=VARCHAR}
        </if>
        <if test="groupName!=null and groupName!=''">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="state != null">
            and state = #{state,jdbcType=INTEGER}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
        <if test="operatiionType != null">
            and operatiion_type = #{operatiionType,jdbcType=INTEGER}
        </if>
        <if test="inQueue != null">
            and in_queue = #{inQueue,jdbcType=INTEGER}
        </if>
        <if test="esRuleName != null and esRuleName!=''">
            and es_rule_name like concat('%',#{esRuleName,jdbcType=VARCHAR},'%')
        </if>
        <if test="begTime!=null">
            and beg_time <![CDATA[>=]]> #{begTime}
        </if>
        <if test="endTime!=null">
            and end_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="createTime!=null">
            and create_time <![CDATA[<]]> #{createTime}
        </if>
        <if test="scalingTypes!=null and scalingTypes.size>0">
            and scaling_type in
            <foreach collection="scalingTypes" item="scalingType" open="(" close=")" separator=",">
                #{scalingType}
            </foreach>
        </if>
        order by end_time ASC
        <if test="page!=null and size!=null">
            limit #{page}, #{size}
        </if>
    </select>

    <select id="selectByParams" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR} and scaling_type != 3
        <if test="vmRole!=null and vmRole!=''">
            and vm_role = #{vmRole,jdbcType=VARCHAR}
        </if>
        <if test="groupName!=null and groupName!=''">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="state != null">
            and state = #{state,jdbcType=INTEGER}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
        <if test="operatiionType != null">
            and operatiion_type = #{operatiionType,jdbcType=INTEGER}
        </if>
        <if test="inQueue != null">
            and in_queue = #{inQueue,jdbcType=INTEGER}
        </if>
        <if test="esRuleName != null and esRuleName!=''">
            and es_rule_name like concat('%',#{esRuleName,jdbcType=VARCHAR},'%')
        </if>
        <if test="begTime!=null">
            and beg_time <![CDATA[>=]]> #{begTime}
        </if>
        <if test="endTime!=null">
            and end_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="createTime!=null">
            and create_time <![CDATA[<]]> #{createTime}
        </if>
        order by create_time desc
        <if test="page!=null and size!=null">
            limit #{page}, #{size}
        </if>
    </select>

    <select id="selectCountByParams" parameterType="map" resultType="int">
        select count(1)
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR}
        <if test="vmRole!=null and vmRole!=''">
            and vm_role = #{vmRole,jdbcType=VARCHAR}
        </if>
        <if test="groupName!=null and groupName!=''">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="state != null">
            and state = #{state,jdbcType=INTEGER}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
        <if test="operatiionType != null">
            and operatiion_type = #{operatiionType,jdbcType=INTEGER}
        </if>
        <if test="inQueue != null">
            and in_queue = #{inQueue,jdbcType=INTEGER}
        </if>
        <if test="esRuleName != null and esRuleName!=''">
            and es_rule_name like concat('%',#{esRuleName,jdbcType=VARCHAR},'%')
        </if>
        <if test="begTime!=null">
            and beg_time <![CDATA[>=]]> #{begTime}
        </if>
        <if test="endTime!=null">
            and end_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="createTime!=null">
            and create_time <![CDATA[<]]> #{createTime}
        </if>
        <if test="scalingTypes!=null and scalingTypes.size>0">
            and scaling_type in
            <foreach collection="scalingTypes" item="scalingType" open="(" close=")" separator=",">
                #{scalingType}
            </foreach>
        </if>
        <if test="stateList!=null and stateList.size>0">
            and state in
            <foreach collection="stateList" item="state" open="(" close=")" separator=",">
                #{state}
            </foreach>
        </if>
        <if test="scaleOutTaskIdIsNull">
            and scaleout_task_id is null
        </if>
    </select>

    <select id="selectAllByEsRuleId" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and es_rule_id = #{esRuleId,jdbcType=VARCHAR}
        order by end_time DESC
        limit #{page}, #{size}
    </select>

    <select id="queryInQueueAndRunningTaskCount" resultMap="BaseResultMap">
        select scaling_type,sum(scaling_count) as scaling_count
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and ((state = 0 and in_queue = 1) or state = 1)
        group by scaling_type
    </select>

    <select id="queryRunningTaskCount" resultType="java.lang.Integer">
        select count(1)
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and state = 1
    </select>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        delete from conf_scaling_task
        where task_id = #{taskId,jdbcType=VARCHAR}
    </delete>
    <insert id="insert" parameterType="com.sunbox.domain.ConfScalingTask">
        insert into conf_scaling_task (task_id, cluster_id, group_name,
                                       scaling_type, vm_role, es_rule_id,
                                       es_rule_name, before_scaling_count, after_scaling_count,
                                       scaling_count, expect_count, is_graceful_scalein, scalein_waitingtime,
                                       operatiion_type, beg_time, end_time, created_by,
                                       state, default_username, enable_beforestart_script, enable_afterstart_script,
                                       create_time, delete_group,
                                       in_queue, scaleout_task_id, force_scalein_data_node)
        values (#{taskId,jdbcType=VARCHAR}, #{clusterId,jdbcType=VARCHAR}, #{groupName,jdbcType=VARCHAR},
                #{scalingType,jdbcType=INTEGER}, #{vmRole,jdbcType=VARCHAR}, #{esRuleId,jdbcType=VARCHAR},
                #{esRuleName,jdbcType=VARCHAR}, #{beforeScalingCount,jdbcType=INTEGER},
                #{afterScalingCount,jdbcType=INTEGER},
                #{scalingCount,jdbcType=INTEGER}, #{expectCount,jdbcType=INTEGER},
                #{isGracefulScalein,jdbcType=INTEGER}, #{scaleinWaitingtime,jdbcType=INTEGER},
                #{operatiionType,jdbcType=INTEGER}, #{begTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP},
                #{createdBy,jdbcType=VARCHAR},
                #{state,jdbcType=INTEGER}, #{defaultUsername,jdbcType=VARCHAR},
                #{enableBeforestartScript,jdbcType=VARCHAR}
                   , #{enableAfterstartScript,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP},
                #{deleteGroup,jdbcType=INTEGER}, #{inQueue,jdbcType=INTEGER},
                #{scaleoutTaskId,jdbcType=VARCHAR}, #{forceScaleinDataNode,jdbcType=INTEGER})
    </insert>
    <insert id="insertSelective" parameterType="com.sunbox.domain.ConfScalingTask">
        insert into conf_scaling_task
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="taskId != null">
                task_id,
            </if>
            <if test="clusterId != null">
                cluster_id,
            </if>
            <if test="groupName != null">
                group_name,
            </if>
            <if test="scalingType != null">
                scaling_type,
            </if>
            <if test="vmRole != null">
                vm_role,
            </if>
            <if test="esRuleId != null">
                es_rule_id,
            </if>
            <if test="esRuleName != null">
                es_rule_name,
            </if>
            <if test="beforeScalingCount != null">
                before_scaling_count,
            </if>
            <if test="afterScalingCount != null">
                after_scaling_count,
            </if>
            <if test="scalingCount != null">
                scaling_count,
            </if>
            <if test="isGracefulScalein != null">
                is_graceful_scalein,
            </if>
            <if test="scaleinWaitingtime != null">
                scalein_waitingtime,
            </if>
            <if test="operatiionType != null">
                operatiion_type,
            </if>
            <if test="begTime != null">
                beg_time,
            </if>
            <if test="endTime != null">
                end_time,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="state != null">
                state,
            </if>
            <if test="enableBeforestartScript != null">
                enable_beforestart_script,
            </if>
            <if test="enableAfterstartScript != null">
                enable_afterstart_script,
            </if>
            <if test="defaultUsername != null">
                default_username,
            </if>
            <if test="forceScaleinDataNode != null">
                force_scalein_data_node,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="taskId != null">
                #{taskId,jdbcType=VARCHAR},
            </if>
            <if test="clusterId != null">
                #{clusterId,jdbcType=VARCHAR},
            </if>
            <if test="groupName != null">
                #{groupName,jdbcType=VARCHAR},
            </if>
            <if test="scalingType != null">
                #{scalingType,jdbcType=INTEGER},
            </if>
            <if test="vmRole != null">
                #{vmRole,jdbcType=VARCHAR},
            </if>
            <if test="esRuleId != null">
                #{esRuleId,jdbcType=VARCHAR},
            </if>
            <if test="esRuleName != null">
                #{esRuleName,jdbcType=VARCHAR},
            </if>
            <if test="beforeScalingCount != null">
                #{beforeScalingCount,jdbcType=INTEGER},
            </if>
            <if test="afterScalingCount != null">
                #{afterScalingCount,jdbcType=INTEGER},
            </if>
            <if test="scalingCount != null">
                #{scalingCount,jdbcType=INTEGER},
            </if>
            <if test="isGracefulScalein != null">
                #{isGracefulScalein,jdbcType=INTEGER},
            </if>
            <if test="scaleinWaitingtime != null">
                #{scaleinWaitingtime,jdbcType=INTEGER},
            </if>
            <if test="operatiionType != null">
                #{operatiionType,jdbcType=INTEGER},
            </if>
            <if test="begTime != null">
                #{begTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null">
                #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="state != null">
                #{state,jdbcType=INTEGER},
            </if>
            <if test="enableBeforestartScript != null">
                #{enableBeforestartScript,jdbcType=INTEGER},
            </if>
            <if test="enableAfterstartScript != null">
                #{enableAfterstartScript,jdbcType=INTEGER},
            </if>
            <if test="defaultUsername != null">
                #{defaultUsername,jdbcType=VARCHAR},
            </if>
            <if test="forceScaleinDataNode != null">
                #{forceScaleinDataNode,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.sunbox.domain.ConfScalingTask">
        update conf_scaling_task
        <set>
            <if test="clusterId != null">
                cluster_id = #{clusterId,jdbcType=VARCHAR},
            </if>
            <if test="groupName != null">
                group_name = #{groupName,jdbcType=VARCHAR},
            </if>
            <if test="scalingType != null">
                scaling_type = #{scalingType,jdbcType=INTEGER},
            </if>
            <if test="vmRole != null">
                vm_role = #{vmRole,jdbcType=VARCHAR},
            </if>
            <if test="esRuleId != null">
                es_rule_id = #{esRuleId,jdbcType=VARCHAR},
            </if>
            <if test="esRuleName != null">
                es_rule_name = #{esRuleName,jdbcType=VARCHAR},
            </if>
            <if test="beforeScalingCount != null">
                before_scaling_count = #{beforeScalingCount,jdbcType=INTEGER},
            </if>
            <if test="afterScalingCount != null">
                after_scaling_count = #{afterScalingCount,jdbcType=INTEGER},
            </if>
            <if test="scalingCount != null">
                scaling_count = #{scalingCount,jdbcType=INTEGER},
            </if>
            <if test="isGracefulScalein != null">
                is_graceful_scalein = #{isGracefulScalein,jdbcType=INTEGER},
            </if>
            <if test="scaleinWaitingtime != null">
                scalein_waitingtime = #{scaleinWaitingtime,jdbcType=INTEGER},
            </if>
            <if test="operatiionType != null">
                operatiion_type = #{operatiionType,jdbcType=INTEGER},
            </if>
            <if test="begTime != null">
                beg_time = #{begTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null">
                end_time = #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="state != null">
                state = #{state,jdbcType=INTEGER},
            </if>
            <if test="enableBeforestartScript != null">
                enable_beforestart_script = #{enableBeforestartScript,jdbcType=INTEGER},
            </if>
            <if test="enableAfterstartScript != null">
                enable_afterstart_script = #{enableAfterstartScript,jdbcType=INTEGER},
            </if>
            <if test="defaultUsername != null">
                default_username = #{defaultUsername,jdbcType=VARCHAR},
            </if>
            <if test="forceScaleinDataNode != null">
                force_scalein_data_node = #{forceScaleinDataNode,jdbcType=INTEGER},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="inQueue != null">
                in_queue = #{inQueue,jdbcType=INTEGER},
            </if>
        </set>
        where task_id = #{taskId,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.sunbox.domain.ConfScalingTask">
        update conf_scaling_task
        set cluster_id = #{clusterId,jdbcType=VARCHAR},
        group_name = #{groupName,jdbcType=VARCHAR},
        scaling_type = #{scalingType,jdbcType=INTEGER},
        vm_role = #{vmRole,jdbcType=VARCHAR},
        es_rule_id = #{esRuleId,jdbcType=VARCHAR},
        es_rule_name = #{esRuleName,jdbcType=VARCHAR},
        before_scaling_count = #{beforeScalingCount,jdbcType=INTEGER},
        after_scaling_count = #{afterScalingCount,jdbcType=INTEGER},
        scaling_count = #{scalingCount,jdbcType=INTEGER},
        is_graceful_scalein = #{isGracefulScalein,jdbcType=INTEGER},
        scalein_waitingtime = #{scaleinWaitingtime,jdbcType=INTEGER},
        operatiion_type = #{operatiionType,jdbcType=INTEGER},
        beg_time = #{begTime,jdbcType=TIMESTAMP},
        end_time = #{endTime,jdbcType=TIMESTAMP},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        state = #{state,jdbcType=INTEGER},
        enable_beforestart_script = #{enableBeforestartScript,jdbcType=INTEGER},
        enable_afterstart_script = #{enableAfterstartScript,jdbcType=INTEGER},
        force_scalein_data_node = #{forceScaleinDataNode,jdbcType=INTEGER},
        default_username = #{defaultUsername,jdbcType=VARCHAR}
        where task_id = #{taskId,jdbcType=VARCHAR}
    </update>
    <select id="countByScalingTypeAndState" resultType="int">
        select count(1)
        from conf_scaling_task
        where cluster_id =#{clusterId,jdbcType=VARCHAR}
        and group_name =#{groupName,jdbcType=VARCHAR}
        and (state = #{state1,jdbcType=INTEGER} or state = #{state2,jdbcType=INTEGER})
        and (scaling_type = #{scalingType1,jdbcType=INTEGER} or scaling_type = #{scalingType2,jdbcType=INTEGER})
    </select>
    <select id="selectRunningOrInqueueTasksByClusterAndGroupName"
            resultType="com.sunbox.domain.ConfScalingTask">
        select * from conf_scaling_task cst
        where (in_queue =1 or state =1)
        and cluster_id = #{clusterId,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
    </select>

    <select id="queryLastOne" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"></include>
        from conf_scaling_task
        <where>
            <if test="taskId != null and taskId != ''">
                and task_id = #{taskId}
            </if>
            <if test="clusterId != null and clusterId != ''">
                and cluster_id = #{clusterId}
            </if>
            <if test="groupName != null and groupName != ''">
                and group_name = #{groupName}
            </if>
            <if test="scalingType != null and scalingType != ''">
                and scaling_type = #{scalingType}
            </if>
            <if test="vmRole != null and vmRole != ''">
                and vm_role = #{vmRole}
            </if>
            <if test="esRuleId != null and esRuleId != ''">
                and es_rule_id = #{esRuleId}
            </if>
            <if test="esRuleName != null and esRuleName != ''">
                and es_rule_name = #{esRuleName}
            </if>
            <if test="beforeScalingCount != null and beforeScalingCount != ''">
                and before_scaling_count = #{beforeScalingCount}
            </if>
            <if test="afterScalingCount != null and afterScalingCount != ''">
                and after_scaling_count = #{afterScalingCount}
            </if>
            <if test="scalingCount != null and scalingCount != ''">
                and scaling_count = #{scalingCount}
            </if>
            <if test="isGracefulScalein != null and isGracefulScalein != ''">
                and is_graceful_scalein = #{isGracefulScalein}
            </if>
            <if test="scaleinWaitingtime != null and scaleinWaitingtime != ''">
                and scalein_waitingtime = #{scaleinWaitingtime}
            </if>
            <if test="defaultUsername != null and defaultUsername != ''">
                and default_username = #{defaultUsername}
            </if>
            <if test="operatiionType != null and operatiionType != ''">
                and operatiion_type = #{operatiionType}
            </if>
            <if test="begTime != null and begTime != ''">
                and beg_time = #{begTime}
            </if>
            <if test="endTime != null and endTime != ''">
                and end_time = #{endTime}
            </if>
            <if test="state != null and state != ''">
                and state = #{state}
            </if>
        </where>
        ORDER BY create_time desc limit 1
    </select>

    <select id="queryRunningTask" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and create_time&lt;#{createTime,jdbcType=TIMESTAMP}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and state in
        <foreach collection="states" item="state" index="index" open="(" close=")" separator=",">
            #{state}
        </foreach>
        order by create_time desc
        limit 1
    </select>
    <select id="queryRunningTaskByScalingType" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and create_time&lt;#{createTime,jdbcType=TIMESTAMP}
        and scaling_type = #{scalingType,jdbcType=INTEGER}
        and state in
        <foreach collection="states" item="state" index="index" open="(" close=")" separator=",">
            #{state}
        </foreach>
        order by create_time desc
        limit 1
    </select>

    <select id="peekQueueHeadTask" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and state in
        <foreach collection="states" item="state" index="index" open="(" close=")" separator=",">
            #{state}
        </foreach>
        order by create_time asc
        limit 1
    </select>

    <select id="findLastByScalingTypeAndState" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and scaling_type = #{scalingType,jdbcType=INTEGER}
        and state = #{state,jdbcType=INTEGER}
        order by end_time desc
        limit 1
    </select>

    <select id="findLastFinishedTask" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and state = #{state,jdbcType=INTEGER}
        order by end_time desc
        limit 1
    </select>
    <select id="findLastTaskByStates" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and group_name = #{groupName,jdbcType=VARCHAR}
        and (state = #{state1,jdbcType=INTEGER} or state = #{state2,jdbcType=INTEGER})
        order by end_time desc
        limit 1
    </select>

    <select id="countRunningTaskByScalingTypes" resultType="int">
        select
        count(1)
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and create_time&lt;#{createTime,jdbcType=TIMESTAMP}
        and scaling_type in
        <foreach collection="scalingTypes" item="scalingType" index="index" open="(" close=")" separator=",">
            #{scalingType}
        </foreach>
        and state in
        <foreach collection="states" item="state" index="index" open="(" close=")" separator=",">
            #{state}
        </foreach>
    </select>
    <select id="countByClusterIdAndStates" resultType="int">
        select
        count(1)
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and state in
        <foreach collection="states" item="state" index="index" open="(" close=")" separator=",">
            #{state}
        </foreach>
    </select>
    <select id="queryTasksByStateAndVmRoleAndClusterId" resultType="com.sunbox.domain.ConfScalingTask">
        select
        <include refid="Base_Column_List"/>
        from conf_scaling_task
        where cluster_id = #{clusterId,jdbcType=VARCHAR}
        and vm_role = #{vmRole,jdbcType=VARCHAR}
        and state = #{state,jdbcType=INTEGER}
        and scaling_type = #{scalingType,jdbcType=INTEGER}
    </select>
    <select id="getAllScaleOutVMCountByClusterAndVmRole" resultType="java.lang.Integer">
        select ifnull(sum(cstv.count),0)
        from conf_scaling_task_vm cstv
                 inner join conf_scaling_task cst on cst.task_id = cstv.task_id
        where cst.cluster_id = #{clusterId,jdbcType=VARCHAR}
          and cst.vm_role = #{vmRole,jdbcType=VARCHAR}
          and cst.task_id &lt;&gt; #{taskId,jdbcType=VARCHAR}
          and cst.create_time &lt; #{createTime,jdbcType=TIMESTAMP}
    </select>

    <select id="countByScaleOutTaskIdAndScalingTypeAndState" resultType="int">
        select count(1)
        from conf_scaling_task
        where cluster_id =#{clusterId,jdbcType=VARCHAR}
          and group_name =#{groupName,jdbcType=VARCHAR}
          and (state = #{state1,jdbcType=INTEGER} or state = #{state2,jdbcType=INTEGER})
          and scaling_type = #{scalingType,jdbcType=INTEGER}
          and scaleout_task_id = #{scaleOutTaskId,jdbcType=VARCHAR}
    </select>

    <select id="getTaskCountByParam" resultType="java.lang.Integer">
        select
        count(*)
        from conf_scaling_task
        where 1=1
        <if test="clusterId != null">
            and cluster_id = #{clusterId,jdbcType=VARCHAR}
        </if>
        <if test="groupName != null">
            and group_name = #{groupName,jdbcType=VARCHAR}
        </if>
        <if test="scalingType != null">
            and scaling_type = #{scalingType,jdbcType=INTEGER}
        </if>
    </select>
</mapper>