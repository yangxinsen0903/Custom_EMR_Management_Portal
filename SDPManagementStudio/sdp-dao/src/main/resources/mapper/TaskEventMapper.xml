<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunbox.dao.mapper.TaskEventMapper">
  <resultMap id="BaseResultMap" type="com.sunbox.domain.TaskEvent">
    <id column="task_event_id" jdbcType="VARCHAR" property="taskEventId" />
    <result column="cluster_id" jdbcType="VARCHAR" property="clusterId" />
    <result column="cluster_name" jdbcType="VARCHAR" property="clusterName" />
    <result column="vm_role" jdbcType="VARCHAR" property="vmRole" />
    <result column="group_name" jdbcType="VARCHAR" property="groupName" />
    <result column="event_type" jdbcType="VARCHAR" property="eventType" />
    <result column="plan_id" jdbcType="VARCHAR" property="planId" />
    <result column="plan_name" jdbcType="VARCHAR" property="planName" />
    <result column="plan_activity_log_id" jdbcType="VARCHAR" property="planActivityLogId" />
    <result column="plan_activity_log_name" jdbcType="VARCHAR" property="planActivityLogName" />
    <result column="event_trigger_time" jdbcType="TIMESTAMP" property="eventTriggerTime" />
    <result column="event_desc" jdbcType="VARCHAR" property="eventDesc" />
  </resultMap>

  <sql id="Base_Column_List">
    task_event_id, cluster_id, cluster_name, vm_role, group_name, event_type, plan_id, plan_name,
    plan_activity_log_id, plan_activity_log_name, event_trigger_time, event_desc
  </sql>

  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from task_event
    where task_event_id = #{taskEventId}
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from task_event
    where task_event_id = #{taskEventId}
  </delete>

  <insert id="insert" parameterType="com.sunbox.domain.TaskEvent">
    insert into task_event (task_event_id, cluster_id, cluster_name, vm_role, group_name, event_type, plan_id, plan_name,
                                           plan_activity_log_id, plan_activity_log_name, event_trigger_time, event_desc)
    values (#{taskEventId,jdbcType=VARCHAR}, #{clusterId,jdbcType=VARCHAR}, #{clusterName,jdbcType=VARCHAR},
            #{vmRole,jdbcType=VARCHAR}, #{groupName,jdbcType=VARCHAR}, #{eventType,jdbcType=VARCHAR},
            #{planId,jdbcType=VARCHAR},#{planName,jdbcType=VARCHAR},#{planActivityLogId,jdbcType=VARCHAR},
            #{planActivityLogName,jdbcType=VARCHAR},
            #{eventTriggerTime,jdbcType=TIMESTAMP}, #{eventDesc,jdbcType=VARCHAR})
  </insert>

  <select id="selectByClusterIdAndPlanId" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from task_event
    where cluster_id = #{clusterId} and plan_id = #{planId}
  </select>

  <select id="selectByPlanIdAndActivityLogId" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from task_event
    where plan_id=#{planId} and plan_activity_log_id=#{planActivityLogId}
  </select>


  <select id="statDestroyTaskFailEventCount" parameterType="map" resultType="java.util.Map">
      select event.cluster_id,
             event.cluster_name,
             event.group_name,
             event.event_type,
             case ccv.purchase_type
                 when 1 then 'ondemand'
                 when 2 then 'spot'
                 end as purchase_type ,
             count(*) as fail_count
      from task_event event
               left join conf_cluster_vm ccv on event.cluster_id = ccv.cluster_id and event.group_name = ccv.group_name
               join conf_cluster cc on event.cluster_id = cc.cluster_id
      where event_type in ('SPOT_SCALEIN_FAIL', 'SPOT_SCALEIN_TIMEOUT', 'ELASTIC_SCALEIN_FAIL',
                           'ELASTIC_SCALEIN_TIMEOUT', 'MANUAL_SCALEIN_FAIL', 'MANUAL_SCALEIN_TIMEOUT',
                           'CLEAN_VM_FAIL', 'CLEAN_VM_TIMEOUT')
        and cc.state = 2
      group by event.cluster_id, event.cluster_name, event.group_name, event.event_type, ccv.purchase_type
  </select>
</mapper>